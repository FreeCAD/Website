{{/* A bunch of JS to load at the end. */}}

{{/* Theme toggle. */}}
{{- if not site.Params.disableChromaToggle -}}
  <script>
    document.getElementById("chroma-toggle").addEventListener("click", () => {
      if (document.body.className.includes("dark")) {
        document.body.classList.remove('dark');
        localStorage.setItem("pref-theme", 'light');
      } else {
        document.body.classList.add('dark');
        localStorage.setItem("pref-theme", 'dark');
      }
    })
  </script>
{{- end -}}

{{- /* Script to detect User Agent and provide corresponding download options. */}}
{{- if or (eq .Section "download") (eq .Section "releases") -}}
  {{- if site.Params.enableUA -}}
    {{- $downloadUA := resources.Get "js/DownloadUACheck.js" -}}
    {{- if hugo.IsProduction -}}
      {{- $downloadUA = minify $downloadUA -}}
    {{- end -}}
    <script type="text/javascript" src="{{ $downloadUA.RelPermalink }}">
    </script>
  {{- end -}}
{{- end -}}

{{- /* Copy Code script. */}}
{{- if (and (eq .Kind "page") (ne .Layout "archives") site.Params.showCopyCodeButton) -}}
  <script>
  document.querySelectorAll('pre > code').forEach((codeblock) => {
    const container = codeblock.parentNode.parentNode;

    const copybutton = document.createElement('button');
    copybutton.classList.add('copy-code');
    copybutton.innerText = '{{- i18n "code_copy" | default "copy" -}}';

    function copyingDone() {
      copybutton.innerText = '{{- i18n "code_copied" | default "copied!" -}}';
      setTimeout(() => {
        copybutton.innerText = '{{- i18n "code_copy" | default "copy" -}}';
      }, 2000);
    }

    copybutton.addEventListener('click', (cb) => {
      if ('clipboard' in navigator) {
        navigator.clipboard.writeText(codeblock.textContent);
        copyingDone();
        return;
      }

      const range = document.createRange();
      range.selectNodeContents(codeblock);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      try {
        document.execCommand('copy');
        copyingDone();
      } catch (e) { };
      selection.removeRange(range);
    });

    if (container.classList.contains("highlight")) {
      container.appendChild(copybutton);
    } else if (container.parentNode.firstChild == container) {
      // td containing LineNos
    } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
      // table containing LineNos and code
      codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
    } else {
      // code blocks not having highlight as parent class
      codeblock.parentNode.appendChild(copybutton);
    }
  });
  </script>
{{- end -}}

{{- /* Script to Open Details block with anchor link. */}}
{{- if site.Params.enableDetailsToggle -}}
  {{- if in .Content "<details" -}}
    {{- $detailsToggle := resources.Get "js/DetailsToggle.js" -}}
    {{- if hugo.IsProduction -}}
      {{- $detailsToggle = minify $detailsToggle -}}
    {{- end -}}
    <script type="text/javascript" src="{{ $detailsToggle.RelPermalink }}"></script>
  {{- end -}}
{{- end -}}

{{- /* Script to validate and submit Donation Box form on Donate page. */}}
{{- if eq .Section "donate" -}}
  {{- if site.Params.enableDonateBox -}}
    {{- $donateBox := resources.Get "js/DonateBox.js" -}}
    {{- if hugo.IsProduction -}}
      {{- $donateBox = minify $donateBox -}}
    {{- end -}}
    {{- if not site.Params.assets.disableFingerprinting -}}
      {{- $donateBox = $donateBox | fingerprint -}}
      <script type="text/javascript" src="{{ $donateBox.RelPermalink }}" integrity="{{ $donateBox.Data.Integrity }}" crossorigin="anonymous"></script>
    {{- else -}}
      <script type="text/javascript" src="{{ $donateBox.RelPermalink }}"></script>
    {{- end -}}
  {{- end -}}
{{- end -}}
