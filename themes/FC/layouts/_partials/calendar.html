{{- with .Params.calendar -}}

  {{- $cal := . -}}
  {{- $host := .host | safeURL -}}
  {{- $query := slice -}}

  {{- range $key := slice "url" "title" "skin" "target" -}}
    {{- with index $cal $key -}}
      {{- $query = $query | append (printf "%s=%s" $key (urlquery .)) -}}
    {{- end -}}
  {{- end -}}

  {{- with .tabs -}}
    {{- range . -}}
      {{- $query = $query | append (printf "tabs=%s" (urlquery .)) -}}
    {{- end -}}
  {{- end -}}

  {{- $menu := .menu | default false -}}
  {{- range $menus := slice "calendar_names" "description" "title" -}}
    {{- $query = $query | append (printf "menu_shows_%s=%t" $menus $menu) -}}
  {{- end -}}

  {{- $css := urlquery ".hamburger-menu,.status-window{display:none;}" -}}
  {{- $query = $query | append (printf "css=%s" $css) -}}

  {{- $query = $query | append "prefer_browser_language=true" -}}
  {{- $query = $query | append "loader=" -}}

  {{- $query := delimit $query "&" -}}

  <iframe id="open-web-calendar"
    class="calendar"
    src="{{ printf "%s?%s" $host $query }}"
    sandbox="allow-scripts allow-same-origin allow-top-navigation"
    allowTransparency="true"
    scrolling="no"
    frameborder="0">
  </iframe>

  {{- $url := .url -}}
  {{- $base_url := "https://calendar.google.com/calendar/embed?src=" -}}
  {{- with findRE `/ical/([^/]+)/` $url -}}
    {{- $id := index . 0 | replaceRE `/ical/([^/]+)/` "${1}" -}}
    <a href="{{ printf "%s%s" $base_url $id }}" target="_blank">Open ICS Calendar</a>
  {{- else -}}
    <a href="{{ $url }}" target="_blank" download>Save ICS Calendar</a>
  {{- end -}}

{{- end -}}


<script>
  function updateCalendarSkin() {
    const iframe = document.getElementById('open-web-calendar');
    if (!iframe) return;

    const isDark = document.body.classList.contains('dark');
    const skin = isDark ? 'dark' : 'terrace';

    const url = new URL(iframe.src);
    url.searchParams.set('skin', skin);

    const newSrc = url.toString();
    if (iframe.src !== newSrc) {
      iframe.src = newSrc;
    }
  }

  document.addEventListener('DOMContentLoaded', updateCalendarSkin);

  const observer = new MutationObserver(updateCalendarSkin);
  observer.observe(document.body, {
    attributes: true,
    attributeFilter: ['class']
  });
</script>