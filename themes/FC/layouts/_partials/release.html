{{- $params := .Params -}}
{{- $platforms := slice -}}
{{- $thanks := "" | default "Thank you for downloading FreeCAD!" -}}
{{- $donate := "" | default "Donate for its development" -}}
{{- $downloadPage := site.GetPage "download" | default (site.Sites.Default.GetPage "download") -}}
{{- with $downloadPage -}}
  {{- with .Params.platforms -}}
    {{- $platforms = . -}}
  {{- end -}}
  {{- with .Params.thanksText -}}
    {{- $thanks = . -}}
  {{- end -}}
{{- end -}}

<div class="download-box">
  {{- range $platform := $platforms -}}
    <div class="cards-column" id="{{ $platform.id }}" style="order: {{ $platform.order }};">
      {{- range $download := $platform.downloads -}}
        {{- with index $params (printf "%s_%s" $platform.id $download.key) -}}
          <a class="arch-icon"
            href="{{ . }}"
            data-url="{{ . }}"
            alt="{{ $download.alt }}"
            aria-label="{{ $download.label }}"
            title="{{ $download.label }}"
            target="_blank"
            rel="noopener noreferrer"
            >
            {{- safeHTML (index site.Data.svg $download.key) -}}<br>
            <span>
              {{ $download.label }}
            </span>
          </a>
        {{- end -}}
      {{- end -}}

      <button type="button"
        popovertarget="{{ $platform.id }}-arch"
        title="{{ $platform.label }}">
        {{- safeHTML (index site.Data.svg $platform.id) -}}<br>
        <span>
          {{ $platform.label }}
        </span>
      </button>
      <span popover id="{{ $platform.id }}-arch"></span>
    </div>
  {{- end -}}
  </div>

{{- $thanks := site.GetPage "thanks" | default (site.Sites.Default.GetPage "thanks") -}}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.arch-icon').forEach(function(link) {
      link.addEventListener('click', function(event) {
        event.preventDefault();

        const fileUrl = link.dataset.url || link.href;
        window.open(fileUrl, '_blank');

        const thanksUrl = "{{ $thanks.RelPermalink }}";
        setTimeout(function() {
          window.location.href = thanksUrl;
        }, 1000);
      });
    });
  });
</script>